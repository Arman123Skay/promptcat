<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>😼</text></svg>">
    <title>promptcat</title>
    <style>
        :root {
            --bg-deep-space: #121019; --bg-space: #1f1d2b; --bg-surface: #272535;
            --border-color: #393649; --primary-accent: #6c5ce7; --primary-hover: #5a4bcd;
            --red-accent: #e74c3c; --red-hover: #c0392b; --yellow-accent: #f1c40f;
            --text-primary: #e0e0e0; --text-secondary: #a0a0b5;
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --sidebar-width: 260px;
            --animation-duration: 0.3s;
        }
        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body { font-family: var(--font-main); background-color: var(--bg-deep-space); color: var(--text-primary); }
        #app { display: flex; width: 100%; height: 100dvh; position: relative; }

        /* --- Scrollbar Hiding --- */
        #sidebar-content, #prompt-list, #prompt-details-container, #tag-suggestions {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* Internet Explorer 10+ */
        }
        #sidebar-content::-webkit-scrollbar, #prompt-list::-webkit-scrollbar, #prompt-details-container::-webkit-scrollbar, #tag-suggestions::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }

        /* --- Sidebar --- */
        #sidebar {
            width: var(--sidebar-width); background-color: var(--bg-space);
            display: flex; flex-direction: column; border-right: 1px solid var(--border-color);
            transition: transform var(--animation-duration) ease-in-out; flex-shrink: 0;
        }
        .sidebar-header { padding: 20px 20px 15px 20px; }
        #search {
            width: 100%; padding: 10px 12px; background: var(--bg-surface);
            border: 1px solid var(--border-color); color: var(--text-primary);
            border-radius: 8px; font-size: 0.95em; appearance: none;
        }
        #search::-webkit-search-cancel-button {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a0a0b5' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='18' y1='6' x2='6' y2='18'%3E%3C/line%3E%3Cline x1='6' y1='6' x2='18' y2='18'%3E%3C/line%3E%3C/svg%3E");
            cursor: pointer; opacity: 0.7;
        }
        #search::-webkit-search-cancel-button:hover { opacity: 1; }

        #sidebar-content { flex-grow: 1; overflow-y: auto; padding: 0 20px; }
        .sidebar-heading {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px;
            color: var(--text-secondary); margin: 25px 0 10px 0; border-top: 1px solid var(--border-color); padding-top: 20px;
        }
        .prompts-heading { border-top: none; margin-top: 10px; padding-top: 0; }
        .sidebar-action-btn {
            background: none; border: none; color: var(--text-secondary); cursor: pointer;
            padding: 4px; border-radius: 5px; line-height: 0;
        }
        .sidebar-action-btn:hover { background-color: var(--bg-surface); color: var(--text-primary); }
        .sidebar-action-btn svg { width: 16px; height: 16px; }

        .sidebar-nav-list { list-style: none; padding: 0; margin: 0; }
        .sidebar-nav-list li {
            display: flex; align-items: center; padding: 10px 12px;
            margin-bottom: 5px; cursor: pointer; border-radius: 6px;
            transition: background-color 0.2s ease, color 0.2s ease;
            color: var(--text-secondary); font-weight: 500;
        }
        .sidebar-nav-list li span:first-child { flex-grow: 1; }
        .sidebar-nav-list li:hover { background-color: var(--bg-surface); }
        .sidebar-nav-list li.active { background-color: var(--primary-accent); color: white; }
        .item-count { font-size: 0.9em; color: var(--text-secondary); opacity: 0.3; transition: display 0.1s ease; }
        .sidebar-nav-list li.active .item-count { color: white; opacity: 0.7; }
        
        #tags-list { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 20px; }
        .tag-item { background-color: var(--bg-surface); color: var(--text-secondary); padding: 4px 10px; font-size: 0.8em; border-radius: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: flex; gap: 6px; align-items: center; }
        .tag-item:hover { background-color: var(--border-color); color: var(--text-primary); }
        .tag-item.active { background-color: var(--primary-accent); color: white; }
        .tag-item .item-count { opacity: 0.7; }
        
        .delete-folder-btn {
            display: none; padding: 2px; border-radius: 4px; cursor: pointer;
            background: none; border: none; color: var(--text-secondary);
            align-items: center; justify-content: center;
        }
        #folder-list li:hover .delete-folder-btn { display: flex; }
        #folder-list li:hover .item-count { display: none; }
        .delete-folder-btn:hover { color: var(--red-accent); }
        
        .inline-form-container { display: grid; grid-template-rows: 0fr; transition: grid-template-rows var(--animation-duration) ease-out; }
        .inline-form-container.visible { grid-template-rows: 1fr; margin-top: 10px; margin-bottom: 10px; }
        .inline-form-content { overflow: hidden; }
        .inline-form-input { width: 100%; padding: 10px 12px; background: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; font-size: 0.95em; }

        .sidebar-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); }
        .io-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
        .io-button { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px; font-size: 0.9em; font-weight: 500; background-color: var(--bg-surface); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease; min-width: 80px; }
        .io-button:hover { background-color: var(--border-color); }
        #import-file-input { display: none; }
        #reset-data-btn { border-color: var(--red-hover); color: var(--text-secondary); flex-basis: 100%;}
        #reset-data-btn:hover { background-color: var(--red-accent); color: white; }

        /* --- Main Content --- */
        #main-content { flex-grow: 1; display: flex; overflow: hidden; position: relative; }
        #sidebar-toggle, #mobile-new-prompt-fab, #close-details-btn, #mobile-search-btn {
            display: none; position: absolute; z-index: 1001;
            background: var(--bg-surface); border: 1px solid var(--border-color);
            color: var(--text-primary); cursor: pointer; border-radius: 12px;
            transition: opacity 0.3s, transform 0.3s;
            width: 44px; height: 44px; font-size: 22px;
            align-items: center; justify-content: center;
        }
        #sidebar-toggle { bottom: 20px; left: 20px; }
        #mobile-new-prompt-fab { bottom: 20px; right: 20px; }
        #mobile-search-btn {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        #mobile-search-btn svg { width: 20px; height: 20px; }
        
        .sidebar-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.2);
            z-index: 999;
            opacity: 0;
            transition: opacity var(--animation-duration) ease-in-out;
            pointer-events: none;
        }
        .sidebar-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #app.sidebar-is-open #sidebar-toggle { 
            transform: scale(0);
            pointer-events: none; 
        }

        #prompt-list-container { width: 35%; min-width: 220px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .prompt-list-controls {
            padding: 10px 15px; display: flex; gap: 10px; align-items: center;
            border-bottom: 1px solid var(--border-color); flex-shrink: 0;
            justify-content: space-between; flex-wrap: nowrap;
        }
        .controls-left, .controls-right { display: flex; gap: 10px; align-items: center; }
        .prompt-list-controls select, .prompt-list-controls button { background-color: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 0 10px; border-radius: 6px; font-size: 0.9em; flex-shrink: 0; height: 32px; line-height: 30px; }
        .prompt-list-controls select { width: auto; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23a0a0b5' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 16px 12px; padding-right: 2rem;}
        
        #select-all-btn {
            max-width: 0;
            opacity: 0;
            transform: scaleX(0);
            transform-origin: left;
            padding: 0;
            border: 0;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        #select-all-btn.visible {
            max-width: 100px;
            opacity: 1;
            transform: scaleX(1);
            padding: 0 10px;
            border: 1px solid var(--border-color);
        }
        #bulk-action-bar {
            display: flex;
            gap: 10px;
            max-width: 0;
            opacity: 0;
            transform: scaleX(0);
            transform-origin: right;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        #bulk-action-bar.visible {
            max-width: 200px;
            opacity: 1;
            transform: scaleX(1);
        }
        #bulk-move-btn, #bulk-delete-btn { color: white; }
        #bulk-move-btn { background-color: var(--primary-accent); }
        #bulk-delete-btn { background-color: var(--red-accent); }
        .prompt-list-controls.select-mode-active #sort-by {
            max-width: 0;
            opacity: 0;
            transform: scaleX(0);
            border: 0;
            padding: 0;
        }
        #sort-by {
            transition: all 0.3s ease;
            max-width: 120px;
            opacity: 1;
            transform-origin: right;
            transform: scaleX(1);
        }


        #prompt-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; height: 100%; position: relative; }
        #prompt-list li { display: flex; align-items: center; gap: 10px; padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s ease; }
        .prompt-info { flex-grow: 1; overflow: hidden; }
        #prompt-list li:hover { background-color: var(--bg-surface); }
        #prompt-list li.active, #prompt-list li.selected { background-color: var(--primary-accent); }
        #prompt-list li.active .prompt-list-title, #prompt-list li.selected .prompt-list-title { color: white; }
        #prompt-list li.active .prompt-list-tag, #prompt-list li.selected .prompt-list-tag { background-color: var(--primary-hover); color: white; }

        .prompt-list-title { font-weight: 600; margin-bottom: 8px; display: block; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .prompt-list-tags { display: flex; flex-wrap: wrap; gap: 5px; }
        .prompt-list-tag { background-color: var(--bg-surface); color: var(--text-secondary); padding: 3px 8px; font-size: 0.75em; border-radius: 10px; font-weight: 500; transition: background-color 0.2s ease; }
        .prompt-list-tag:hover { background-color: var(--primary-accent); color: white; }
        
        #new-prompt-placeholder {
            display: none; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; text-align: center; color: var(--text-secondary); padding: 20px;
        }
        #new-prompt-placeholder.visible { display: flex; }
        #new-prompt-placeholder p { margin-bottom: 20px; }
        #new-prompt-placeholder-btn {
            background-color: var(--primary-accent); color: white;
            padding: 12px 24px; font-size: 1em; font-weight: 500; border-radius: 8px;
            border: none; cursor: pointer; transition: background-color 0.2s ease;
        }
        #new-prompt-placeholder-btn:hover { background-color: var(--primary-hover); }

        .prompt-actions { display: flex; align-items: center; gap: 15px; margin-left: auto; flex-shrink: 0; }
        .select-checkbox { transform: scale(1.2); }
        .favorite-toggle {
            cursor: pointer; color: var(--text-secondary); line-height: 1; opacity: 0.3;
            transition: opacity 0.2s, color 0.2s ease; flex-shrink: 0;
        }
        .favorite-toggle:hover { opacity: 0.7; }
        .favorite-toggle.active { opacity: 1; color: var(--primary-accent); }
        .favorite-toggle svg { width: 20px; height: 20px; display: block; }

        #prompt-details-container { flex-grow: 1; padding: 25px; overflow-y: auto; position: relative; display: flex; flex-direction: column;}
        #no-prompt-selected { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; color: var(--text-secondary); text-align: center; transition: opacity 0.3s ease-out; }
        
        #prompt-details { display: none; height: 100%; display: flex; flex-direction: column; }
        
        @media (min-width: 769px) {
            #prompt-details { animation: fadeIn var(--animation-duration) ease-in-out; }
            #prompt-details.closing { animation: fadeOut var(--animation-duration) ease-in-out forwards; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(10px); } }
        }

        .form-group { position: relative; margin-bottom: 15px; }
        .form-group.grows { flex-grow: 1; display: flex; flex-direction: column; }
        .form-group.grows textarea { flex-grow: 1; resize: none; }

        .form-group label { font-weight: 600; font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; display: block; }
        input, textarea, select { width: 100%; padding: 12px; background: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; font-size: 1em; line-height: 1.5; font-family: var(--font-main); }
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23a0a0b5' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            padding-right: 2.5rem;
        }
        #char-counter { text-align: right; font-size: 0.8em; color: var(--text-secondary); margin-top: 5px; padding-right: 5px; }
        #copy-prompt-btn { position: absolute; top: 35px; right: 8px; background: transparent; color: var(--text-secondary); border: none; border-radius: 5px; cursor: pointer; width: 30px; height: 30px; padding: 4px; transition: color 0.2s ease; }
        #copy-prompt-btn:hover { color: var(--text-primary); }
        #copy-prompt-btn.copied { color: var(--primary-accent); }
        
        .action-buttons { margin-top: 20px; display: flex; gap: 10px; }
        .action-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1em; font-weight: 500; padding: 12px; border-radius: 8px; border: none; cursor: pointer; transition: background-color 0.2s ease; }
        #save-prompt { background-color: var(--primary-accent); color: white; }
        #delete-prompt { background-color: var(--red-accent); color: white; }
        .tags-container { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; padding: 6px; background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 8px; }
        .tags-container .tag { display: flex; align-items: center; gap: 5px; background-color: var(--primary-accent); padding: 4px 8px; border-radius: 5px; font-size: 0.9em; }
        .tags-container .remove-tag { cursor: pointer; font-weight: bold; font-size: 14px; }
        #tags-input { flex-grow: 1; background: none; border: none; color: var(--text-primary); padding: 4px; font-size: 1em; min-width: 100px; }
        
        #tag-suggestions {
            display: none; position: absolute;
            top: 100%; left: 0; right: 0;
            background-color: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-top: none; border-radius: 0 0 8px 8px;
            max-height: 150px; overflow-y: auto; z-index: 10;
        }
        .suggestion-item { padding: 10px 12px; cursor: pointer; transition: background-color 0.2s ease; }
        .suggestion-item:hover, .suggestion-item.active { background-color: var(--primary-accent); color: white; }

        /* --- Modal --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); z-index: 1000;
            justify-content: center; align-items: center; animation: fadeInModal 0.2s ease-out;
        }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }

        .modal-content {
            background-color: var(--bg-space); padding: 25px; border-radius: 12px;
            border: 1px solid var(--border-color); width: 90%; max-width: 400px;
            animation: slideInModal var(--animation-duration) ease-out;
        }
        @keyframes slideInModal { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-content h3 { margin-top: 0; }
        .modal-content select { margin-bottom: 20px; }
        .modal-content p { margin-bottom: 25px; line-height: 1.6; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        #confirm-reset-btn, .modal-confirm-btn.danger { background-color: var(--red-accent); color: white; }
        #confirm-reset-btn:hover, .modal-confirm-btn.danger:hover { background-color: var(--red-hover); }
        
        /* --- Mobile --- */
        #mobile-search-bar { display: none; }
        #close-details-btn {
            bottom: 20px;
            right: 20px;
        }
        @media (max-width: 768px) {
            #sidebar-header { display: none; }
            #mobile-search-bar {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                z-index: 10;
                background-color: var(--bg-deep-space);
                padding: 10px 15px;
                display: flex;
                gap: 10px;
                align-items: center;
                transform: translateY(-100%);
                transition: transform 0.3s ease;
                border-bottom: 1px solid var(--border-color);
            }
            #mobile-search-bar.visible {
                transform: translateY(0);
            }
            #mobile-search-input {
                width: 100%;
                height: 44px;
            }
            #close-search-btn {
                background: var(--bg-surface);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                cursor: pointer;
                border-radius: 12px;
                width: 44px;
                height: 44px;
                font-size: 22px;
                flex-shrink: 0;
            }

            #app { overflow-x: hidden; }
            #sidebar { position: absolute; left: 0; top: 0; height: 100%; z-index: 1000; transform: translateX(-100%); }
            #sidebar.visible { transform: translateX(0); }
            #main-content { position: absolute; width: 100%; height: 100%; transition: transform var(--animation-duration) ease-in-out; }
            #prompt-list-container, #prompt-details-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; transition: transform var(--animation-duration) ease-in-out; }
            #prompt-details-container {
                transform: translateX(100%);
                z-index: 20;
                background: var(--bg-deep-space);
                padding: 25px 20px 90px;
            }
            #app.details-visible-mobile #prompt-details-container { transform: translateX(0); }
            #app.details-visible-mobile #mobile-new-prompt-fab {
                transform: scale(0);
                pointer-events: none; 
            }
            #app.details-visible-mobile #mobile-search-btn,
            #app.sidebar-is-open #mobile-search-btn {
                transform: translateX(-50%) scale(0);
                pointer-events: none;
            }
            #app.details-visible-mobile #close-details-btn { display: flex; }
            
            #sidebar-toggle, #mobile-new-prompt-fab, #mobile-search-btn { display: flex; }

            .prompt-list-controls { flex-wrap: wrap; }
            .prompt-list-controls.select-mode-active #sort-by { display: none; }
            
            #prompt-list {
                padding-bottom: 80px; /* Space for FABs */
            }
        }
        
        .button-emoji { font-size: 1.2em; display: none; }
        @media (max-width: 420px) {
            #bulk-move-btn .button-text, #bulk-delete-btn .button-text { display: none; }
            #bulk-move-btn .button-emoji, #bulk-delete-btn .button-emoji { display: inline; }
            #bulk-move-btn, #bulk-delete-btn { width: 40px; justify-content: center; padding: 0 5px; }
        }
    </style>
</head>
<body>

<div id="app">
    <div id="sidebar">
        <div class="sidebar-header">
            <input type="search" id="search" placeholder="Search prompts...">
        </div>
        <div id="sidebar-content">
            <div class="sidebar-heading prompts-heading">
                <span>Prompts</span>
                <button class="sidebar-action-btn" id="new-prompt-btn" title="New Prompt"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
            </div>
            <ul id="primary-nav-list" class="sidebar-nav-list"></ul>
            
            <div class="sidebar-heading">
                <span>Folders</span>
                <button class="sidebar-action-btn" id="new-folder-toggle-btn" title="New Folder"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
            </div>
            <div id="new-folder-container" class="inline-form-container">
                <div class="inline-form-content">
                    <input type="text" id="new-folder-name" class="inline-form-input" placeholder="New folder name...">
                    <button id="add-folder-btn" class="io-button" style="margin-top: 10px; width: 100%;">Add Folder</button>
                </div>
            </div>
            <ul id="folder-list" class="sidebar-nav-list"></ul>

            <div class="sidebar-heading">
                <span>Tags</span>
                <button class="sidebar-action-btn" id="new-tag-toggle-btn" title="New Tag"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
            </div>
            <div id="new-tag-container" class="inline-form-container">
                <div class="inline-form-content">
                    <input type="text" id="new-tag-name" class="inline-form-input" placeholder="New tag name...">
                    <button id="add-tag-btn" class="io-button" style="margin-top: 10px; width: 100%;">Add Tag</button>
                </div>
            </div>
            <div id="tags-list"></div>
        </div>
        <div class="sidebar-footer">
            <div class="io-buttons">
                <button id="import-btn" class="io-button"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg> Import </button>
                <input type="file" id="import-file-input" accept=".json">
                <button id="export-btn" class="io-button"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Export </button>
                <button id="reset-data-btn" class="io-button"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> Reset </button>
            </div>
        </div>
    </div>
    <div id="main-content">
        <button id="sidebar-toggle">☰</button>
        <button id="mobile-search-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button>
        <button id="mobile-new-prompt-fab">+</button>
        <div id="prompt-list-container">
            <div id="mobile-search-bar">
                <input type="search" id="mobile-search-input" class="inline-form-input" placeholder="Search prompts...">
                <button id="close-search-btn">×</button>
            </div>
            <div class="prompt-list-controls">
                <div class="controls-left">
                    <button id="select-mode-btn">Select</button>
                    <button id="select-all-btn">Select All</button>
                </div>
                <div class="controls-right">
                    <div id="bulk-action-bar">
                        <button id="bulk-move-btn"><span class="button-text">Move</span><span class="button-emoji">📁</span></button>
                        <button id="bulk-delete-btn"><span class="button-text">Delete</span><span class="button-emoji">🗑️</span></button>
                    </div>
                    <select id="sort-by">
                        <option value="dateCreated_desc">Newest</option>
                        <option value="title_asc">Title (A-Z)</option>
                    </select>
                </div>
            </div>
            <ul id="prompt-list">
                 <div id="new-prompt-placeholder">
                    <p>No prompts here yet. Let's create one!</p>
                    <button id="new-prompt-placeholder-btn">Create New Prompt</button>
                </div>
            </ul>
        </div>
        <div id="prompt-details-container">
            <div id="no-prompt-selected">
                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                <p style="margin-top: 20px;">Select a prompt to view, or create a new one.</p>
            </div>
            <div id="prompt-details">
                <div class="form-group"> <label for="prompt-title">Title</label> <input type="text" id="prompt-title" placeholder="Prompt Title"> </div>
                <div class="form-group"> <label for="prompt-folder">Folder</label> <select id="prompt-folder"></select> </div>
                <div class="form-group grows">
                    <label for="prompt-body">Prompt</label>
                    <textarea id="prompt-body" placeholder="The content of your prompt..."></textarea>
                    <div id="char-counter">0 characters</div>
                    <button id="copy-prompt-btn" title="Copy prompt body"> <svg class="copy-icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> </button>
                </div>
                <div class="form-group"> <label for="prompt-notes">Notes</label> <textarea id="prompt-notes" rows="2" placeholder="Add extra details or context..."></textarea> </div>
                <div class="form-group"> 
                    <label for="tags-input">Tags</label> 
                    <div class="tags-container" id="tags-container"> 
                        <input type="text" id="tags-input" placeholder="Add tags..."> 
                    </div> 
                    <div id="tag-suggestions"></div>
                </div>
                <div class="action-buttons">
                    <button id="save-prompt" class="action-btn">Save</button>
                    <button id="delete-prompt" class="action-btn">Delete</button>
                </div>
            </div>
        </div>
        <button id="close-details-btn">×</button>
    </div>
    
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- MODALS -->
    <div id="move-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Move Prompts</h3>
            <p>Select a destination folder for the <span id="move-count"></span> selected prompts.</p>
            <select id="move-folder-select" class="inline-form-input"></select>
            <div class="modal-actions">
                <button id="cancel-move-btn" class="io-button">Cancel</button>
                <button id="confirm-move-btn" class="action-btn" style="background-color: var(--primary-accent); color: white;">Move</button>
            </div>
        </div>
    </div>

    <div id="delete-folder-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Delete Folder</h3>
            <p>What would you like to do with the prompts inside this folder?</p>
            <div class="modal-actions" style="flex-direction: column; gap: 15px; align-items: stretch;">
                <button id="confirm-delete-folder-move-prompts" class="action-btn">Delete Folder &amp; Move Prompts</button>
                <button id="confirm-delete-folder-and-prompts" class="action-btn">Delete Folder &amp; All Prompts</button>
                <button id="cancel-delete-folder-btn" class="io-button">Cancel</button>
            </div>
        </div>
    </div>

    <div id="reset-data-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Reset All Data</h3>
            <p>Are you sure you want to reset all data? This will permanently delete all prompts, folders, and tags. This action cannot be undone.</p>
            <div class="modal-actions">
                <button id="cancel-reset-btn" class="io-button">Cancel</button>
                <button id="confirm-reset-btn" class="action-btn">Yes, Reset Everything</button>
            </div>
        </div>
    </div>

    <div id="generic-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="generic-modal-title"></h3>
            <p id="generic-modal-message"></p>
            <input type="text" id="generic-modal-input" class="inline-form-input" style="margin-bottom: 20px; display: none;">
            <div class="modal-actions">
                <button id="generic-modal-cancel-btn" class="io-button">Cancel</button>
                <button id="generic-modal-confirm-btn" class="action-btn modal-confirm-btn">OK</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const UI = {
        app: document.getElementById('app'),
        sidebar: document.getElementById('sidebar'),
        sidebarOverlay: document.getElementById('sidebar-overlay'),
        mainContent: document.getElementById('main-content'),
        sidebarToggle: document.getElementById('sidebar-toggle'),
        mobileNewPromptFab: document.getElementById('mobile-new-prompt-fab'),
        promptList: document.getElementById('prompt-list'),
        newPromptPlaceholder: document.getElementById('new-prompt-placeholder'),
        promptDetails: document.getElementById('prompt-details'),
        noPromptSelected: document.getElementById('no-prompt-selected'),
        closeDetailsBtn: document.getElementById('close-details-btn'),
        promptTitle: document.getElementById('prompt-title'),
        promptBody: document.getElementById('prompt-body'),
        promptNotes: document.getElementById('prompt-notes'),
        promptFolder: document.getElementById('prompt-folder'),
        copyPromptBtn: document.getElementById('copy-prompt-btn'),
        newPromptBtn: document.getElementById('new-prompt-btn'),
        savePromptBtn: document.getElementById('save-prompt'),
        deletePromptBtn: document.getElementById('delete-prompt'),
        search: document.getElementById('search'),
        primaryNavList: document.getElementById('primary-nav-list'),
        folderList: document.getElementById('folder-list'),
        newFolderContainer: document.getElementById('new-folder-container'),
        newFolderToggleBtn: document.getElementById('new-folder-toggle-btn'),
        newFolderName: document.getElementById('new-folder-name'),
        addFolderBtn: document.getElementById('add-folder-btn'),
        newTagContainer: document.getElementById('new-tag-container'),
        newTagToggleBtn: document.getElementById('new-tag-toggle-btn'),
        newTagName: document.getElementById('new-tag-name'),
        addTagBtn: document.getElementById('add-tag-btn'),
        tagsContainer: document.getElementById('tags-container'),
        tagsInput: document.getElementById('tags-input'),
        tagSuggestions: document.getElementById('tag-suggestions'),
        charCounter: document.getElementById('char-counter'),
        tagsList: document.getElementById('tags-list'),
        sortBy: document.getElementById('sort-by'),
        selectModeBtn: document.getElementById('select-mode-btn'),
        selectAllBtn: document.getElementById('select-all-btn'),
        bulkActionBar: document.getElementById('bulk-action-bar'),
        bulkMoveBtn: document.getElementById('bulk-move-btn'),
        bulkDeleteBtn: document.getElementById('bulk-delete-btn'),
        importBtn: document.getElementById('import-btn'),
        importFileInput: document.getElementById('import-file-input'),
        exportBtn: document.getElementById('export-btn'),
        resetDataBtn: document.getElementById('reset-data-btn'),

        // Mobile Search
        mobileSearchBtn: document.getElementById('mobile-search-btn'),
        mobileSearchBar: document.getElementById('mobile-search-bar'),
        mobileSearchInput: document.getElementById('mobile-search-input'),
        closeSearchBtn: document.getElementById('close-search-btn'),
        
        // Modals
        moveModal: document.getElementById('move-modal'),
        moveCount: document.getElementById('move-count'),
        moveFolderSelect: document.getElementById('move-folder-select'),
        cancelMoveBtn: document.getElementById('cancel-move-btn'),
        confirmMoveBtn: document.getElementById('confirm-move-btn'),
        promptListControls: document.querySelector('.prompt-list-controls'),
        deleteFolderModal: document.getElementById('delete-folder-modal'),
        cancelDeleteFolderBtn: document.getElementById('cancel-delete-folder-btn'),
        confirmDeleteFolderMoveBtn: document.getElementById('confirm-delete-folder-move-prompts'),
        confirmDeleteFolderAndPromptsBtn: document.getElementById('confirm-delete-folder-and-prompts'),
        resetDataModal: document.getElementById('reset-data-modal'),
        cancelResetBtn: document.getElementById('cancel-reset-btn'),
        confirmResetBtn: document.getElementById('confirm-reset-btn'),
        
        // Generic Modal
        genericModal: document.getElementById('generic-modal'),
        genericModalTitle: document.getElementById('generic-modal-title'),
        genericModalMessage: document.getElementById('generic-modal-message'),
        genericModalInput: document.getElementById('generic-modal-input'),
        genericModalCancelBtn: document.getElementById('generic-modal-cancel-btn'),
        genericModalConfirmBtn: document.getElementById('generic-modal-confirm-btn'),
    };

    const ModalService = {
        show: (config) => {
            return new Promise((resolve) => {
                UI.genericModalTitle.textContent = config.title || '';
                UI.genericModalMessage.textContent = config.message || '';
                
                UI.genericModalInput.style.display = 'none';
                UI.genericModalCancelBtn.style.display = 'inline-flex';
                UI.genericModalConfirmBtn.classList.remove('danger');
                
                if (config.type === 'alert') {
                    UI.genericModalCancelBtn.style.display = 'none';
                }
                
                if (config.type === 'prompt') {
                    UI.genericModalInput.style.display = 'block';
                    UI.genericModalInput.value = config.defaultValue || '';
                    setTimeout(() => UI.genericModalInput.focus(), 50);
                }

                UI.genericModalConfirmBtn.textContent = config.confirmBtnText || 'OK';
                UI.genericModalCancelBtn.textContent = config.cancelBtnText || 'Cancel';
                if (config.danger) UI.genericModalConfirmBtn.classList.add('danger');

                UI.genericModal.style.display = 'flex';

                const onConfirm = () => {
                    cleanup();
                    resolve(config.type === 'prompt' ? UI.genericModalInput.value : true);
                };

                const onCancel = () => {
                    cleanup();
                    resolve(config.type === 'prompt' ? null : false);
                };

                const cleanup = () => {
                    UI.genericModal.style.display = 'none';
                    UI.genericModalConfirmBtn.removeEventListener('click', onConfirm);
                    UI.genericModalCancelBtn.removeEventListener('click', onCancel);
                    UI.genericModal.removeEventListener('click', onOverlayClick);
                };
                
                const onOverlayClick = (e) => {
                    if (e.target === UI.genericModal) onCancel();
                }

                UI.genericModalConfirmBtn.addEventListener('click', onConfirm);
                UI.genericModalCancelBtn.addEventListener('click', onCancel);
                UI.genericModal.addEventListener('click', onOverlayClick);
            });
        },
        alert: (message, title = 'Alert') => ModalService.show({ type: 'alert', title, message, confirmBtnText: 'OK' }),
        confirm: (message, config = {}) => ModalService.show({ type: 'confirm', ...config, message }),
        prompt: (message, config = {}) => ModalService.show({ type: 'prompt', ...config, message }),
    };

    let state = {
        prompts: [],
        folders: [],
        globalTags: [],
        currentTags: [],
        view: { type: 'folder', id: 'all' },
        currentPromptId: null,
        isCreatingNew: false,
        isSelectMode: false,
        selectedPromptIds: new Set(),
        sortBy: 'dateCreated_desc',
        folderToDeleteId: null,
        copyTimeout: null,
    };

    function init() { loadData(); attachEventListeners(); updateUI(); }
    function loadData() {
        state.prompts = JSON.parse(localStorage.getItem('prompts')) || [];
        state.folders = JSON.parse(localStorage.getItem('folders')) || [];
        state.globalTags = JSON.parse(localStorage.getItem('globalTags')) || [];
    }
    function saveData() {
        localStorage.setItem('prompts', JSON.stringify(state.prompts));
        localStorage.setItem('folders', JSON.stringify(state.folders));
        localStorage.setItem('globalTags', JSON.stringify(state.globalTags));
    }
    
    function updateUI() {
        const detailsVisible = state.isCreatingNew || !!state.currentPromptId;
        renderSidebarNav();
        renderSidebarTags();
        renderPrompts();
        renderPromptDetails(detailsVisible);
        updateBulkActionUI();
        UI.app.classList.toggle('details-visible-mobile', detailsVisible);
    }

    function renderSidebarNav() {
        const allPromptsCount = state.prompts.length;
        const favoritesCount = state.prompts.filter(p => p.isFavorite).length;
        
        UI.primaryNavList.innerHTML = `
            <li data-type="folder" data-id="all" class="${state.view.type === 'folder' && state.view.id === 'all' ? 'active' : ''}">
                <span>All Prompts</span><span class="item-count">${allPromptsCount}</span>
            </li>
            <li data-type="folder" data-id="favorites" class="${state.view.type === 'folder' && state.view.id === 'favorites' ? 'active' : ''}">
                <span>Favorites</span><span class="item-count">${favoritesCount}</span>
            </li>
        `;
        
        UI.folderList.innerHTML = '';
        state.folders.forEach(folder => {
            const folderCount = state.prompts.filter(p => p.folderId === folder.id).length;
            const li = document.createElement('li');
            li.dataset.type = 'folder'; li.dataset.id = folder.id;
            li.classList.toggle('active', state.view.type === 'folder' && state.view.id === folder.id);
            li.innerHTML = `
                <span>${folder.name}</span>
                <span class="item-count">${folderCount}</span>
                <button class="delete-folder-btn" data-folder-id="${folder.id}" title="Delete Folder">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            `;
            UI.folderList.appendChild(li);
        });
    }
    
    function renderSidebarTags() {
        const allUniqueTags = [...new Set([...state.prompts.flatMap(p => p.tags || []), ...state.globalTags])].sort();
        UI.tagsList.innerHTML = '';
        allUniqueTags.forEach(tag => {
            const tagCount = state.prompts.filter(p => (p.tags || []).includes(tag)).length;
            const tagEl = document.createElement('div');
            tagEl.className = 'tag-item';
            tagEl.dataset.type = 'tag'; tagEl.dataset.id = tag;
            if (state.view.type === 'tag' && state.view.id === tag) tagEl.classList.add('active');
            tagEl.innerHTML = `${tag}<span class="item-count">${tagCount}</span>`;
            UI.tagsList.appendChild(tagEl);
        });
    }

    function getFilteredAndSortedPrompts() {
        let list = [...state.prompts];
        const desktopQuery = UI.search.value.trim().toLowerCase();
        const mobileQuery = UI.mobileSearchInput.value.trim().toLowerCase();
        const query = window.innerWidth <= 768 ? mobileQuery : desktopQuery;

        if (query) {
            list = list.filter(p => [p.title, p.body, p.notes, ...(p.tags || [])].join(' ').toLowerCase().includes(query));
            if (state.view.type !== 'search') { state.view = {type: 'search'}; renderSidebarNav(); }
        } else if (state.view.type === 'tag') {
            list = list.filter(p => (p.tags || []).includes(state.view.id));
        } else if (state.view.type === 'folder') {
            if (state.view.id === 'favorites') list = list.filter(p => p.isFavorite);
            else if (state.view.id !== 'all') list = list.filter(p => p.folderId === state.view.id);
        }
        
        const [sortKey, sortDir] = state.sortBy.split('_');
        list.sort((a, b) => {
            let valA = a[sortKey], valB = b[sortKey];
            if (sortKey === 'title') { valA = (valA || '').toLowerCase(); valB = (valB || '').toLowerCase(); }
            if (valA < valB) return sortDir === 'asc' ? -1 : 1;
            if (valA > valB) return sortDir === 'asc' ? 1 : -1;
            return 0;
        });
        return list;
    }

    function renderPrompts() {
        UI.promptList.querySelectorAll('li').forEach(li => li.remove());
        const promptsToRender = getFilteredAndSortedPrompts();

        UI.newPromptPlaceholder.classList.toggle('visible', promptsToRender.length === 0 && !UI.search.value.trim() && !UI.mobileSearchInput.value.trim());
        
        promptsToRender.forEach(prompt => {
            const li = document.createElement('li');
            li.dataset.id = prompt.id;
            li.classList.toggle('active', prompt.id === state.currentPromptId && !state.isSelectMode);
            li.classList.toggle('selected', state.isSelectMode && state.selectedPromptIds.has(prompt.id));

            li.innerHTML = `
                <div class="prompt-info">
                    <span class="prompt-list-title">${prompt.title || 'Untitled Prompt'}</span>
                    <div class="prompt-list-tags">${(prompt.tags || []).map(tag => `<span class="prompt-list-tag" data-tag="${tag}">${tag}</span>`).join('')}</div>
                </div>
                <div class="prompt-actions">
                    <span class="favorite-toggle ${prompt.isFavorite ? 'active' : ''}" data-id="${prompt.id}" title="Toggle Favorite">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.77 5.82 22 7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                    </span>
                </div>
            `;
            UI.promptList.appendChild(li);
        });
    }

    function renderPromptDetails(show) {
        if (show) {
            UI.noPromptSelected.style.display = 'none';
            UI.promptDetails.style.display = 'flex';
            renderFolderDropdown();
            const prompt = state.prompts.find(p => p.id === state.currentPromptId);
            if (prompt) {
                UI.promptTitle.value = prompt.title; UI.promptBody.value = prompt.body;
                UI.promptNotes.value = prompt.notes || ''; UI.promptFolder.value = prompt.folderId || 'all';
                loadTags(prompt.tags || []); updateCharCounter();
            }
        } else {
            UI.noPromptSelected.style.display = 'flex';
            UI.promptDetails.style.display = 'none';
        }
    }
    
    function renderFolderDropdown() {
        const currentFolder = UI.promptFolder.value;
        UI.promptFolder.innerHTML = `<option value="all">No Folder</option>`;
        state.folders.forEach(folder => UI.promptFolder.innerHTML += `<option value="${folder.id}">${folder.name}</option>`);
        UI.promptFolder.innerHTML += `<option value="--create-new--" style="color: var(--primary-accent); font-weight: bold;">-- Create New Folder --</option>`;
        UI.promptFolder.value = currentFolder;
    }

    function openPromptDetailsView(isNew, promptId = null) {
        state.isCreatingNew = isNew;
        state.currentPromptId = promptId;
        if (isNew) {
            UI.promptTitle.value = ''; UI.promptBody.value = ''; UI.promptNotes.value = '';
            updateCharCounter(); loadTags([]);
            if (state.view.type === 'folder' && state.view.id !== 'all' && state.view.id !== 'favorites') {
                UI.promptFolder.value = state.view.id;
            } else {
                UI.promptFolder.value = 'all';
            }
            UI.promptTitle.focus();
        }
        updateUI();
        if (window.innerWidth <= 768) { UI.app.classList.remove('sidebar-is-open'); UI.sidebar.classList.remove('visible'); }
    }

    function closePromptDetailsView() {
        const animationDuration = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--animation-duration')) * 1000;
        
        if (window.innerWidth > 768) {
            UI.promptDetails.classList.add('closing');
        } else {
            UI.app.classList.remove('details-visible-mobile');
        }
        
        setTimeout(() => {
            if(window.innerWidth > 768) UI.promptDetails.classList.remove('closing');
            state.isCreatingNew = false;
            state.currentPromptId = null;
            updateUI();
        }, animationDuration);
    }

    function renderTags() {
        UI.tagsContainer.querySelectorAll('.tag').forEach(tagEl => tagEl.remove());
        state.currentTags.forEach(tagText => {
            const tagEl = document.createElement('span');
            tagEl.className = 'tag';
            tagEl.innerHTML = `${tagText}<span class="remove-tag" data-tag="${tagText}">&times;</span>`;
            UI.tagsContainer.insertBefore(tagEl, UI.tagsInput);
        });
    }
    function addTag(tagText) {
        const text = tagText.trim().replace(/,/g, '');
        if (text && !state.currentTags.includes(text)) { 
            state.currentTags.push(text); 
            renderTags(); 
        }
    }
    function removeTag(tagText) { state.currentTags = state.currentTags.filter(t => t !== tagText); renderTags(); }
    function loadTags(tagsArray) { state.currentTags = [...(tagsArray || [])]; renderTags(); }
    function updateCharCounter() { UI.charCounter.textContent = `${UI.promptBody.value.length} characters`; }
    
    function toggleSelectMode() { 
        state.isSelectMode = !state.isSelectMode; 
        if (!state.isSelectMode) {
            state.selectedPromptIds.clear();
        }
        UI.promptListControls.classList.toggle('select-mode-active', state.isSelectMode);
        updateUI(); 
    }
    function updateBulkActionUI() {
        UI.selectModeBtn.textContent = state.isSelectMode ? 'Cancel' : 'Select';
        UI.selectAllBtn.classList.toggle('visible', state.isSelectMode);
        UI.bulkActionBar.classList.toggle('visible', state.isSelectMode && state.selectedPromptIds.size > 0);
    }

    function closeMobileSidebar() {
        UI.app.classList.remove('sidebar-is-open');
        UI.sidebar.classList.remove('visible');
        UI.sidebarOverlay.classList.remove('visible');
    }

    function attachEventListeners() {
        UI.newPromptBtn.addEventListener('click', () => openPromptDetailsView(true));
        UI.mobileNewPromptFab.addEventListener('click', () => openPromptDetailsView(true));
        document.getElementById('new-prompt-placeholder-btn').addEventListener('click', () => openPromptDetailsView(true));
        UI.savePromptBtn.addEventListener('click', handleSavePrompt);
        UI.deletePromptBtn.addEventListener('click', handleDeletePrompt);
        UI.search.addEventListener('input', () => { updateUI(); });
        UI.mobileSearchInput.addEventListener('input', () => { updateUI(); });
        UI.closeDetailsBtn.addEventListener('click', closePromptDetailsView);
        UI.copyPromptBtn.addEventListener('click', handleCopyPrompt);
        
        UI.primaryNavList.addEventListener('click', handleSidebarNavClick);
        UI.folderList.addEventListener('click', handleSidebarNavClick);
        UI.tagsList.addEventListener('click', handleSidebarNavClick);
        UI.promptList.addEventListener('click', handlePromptListClick);
        
        UI.newFolderToggleBtn.addEventListener('click', () => {
            const container = UI.newFolderContainer;
            container.classList.toggle('visible');
            if (container.classList.contains('visible')) {
                UI.newFolderName.focus();
                setTimeout(() => container.scrollIntoView({ behavior: "smooth", block: "nearest" }), 50);
            }
        });
        UI.addFolderBtn.addEventListener('click', handleAddFolder);

        UI.newTagToggleBtn.addEventListener('click', () => {
            const container = UI.newTagContainer;
            container.classList.toggle('visible');
            if (container.classList.contains('visible')) {
                UI.newTagName.focus();
                setTimeout(() => container.scrollIntoView({ behavior: "smooth", block: "nearest" }), 50);
            }
        });
        UI.addTagBtn.addEventListener('click', handleAddGlobalTag);

        UI.sortBy.addEventListener('change', e => { state.sortBy = e.target.value; renderPrompts(); });
        UI.selectModeBtn.addEventListener('click', toggleSelectMode);
        UI.selectAllBtn.addEventListener('click', handleSelectAll);
        UI.bulkDeleteBtn.addEventListener('click', handleBulkDelete);
        UI.bulkMoveBtn.addEventListener('click', handleBulkMove);
        UI.importBtn.addEventListener('click', () => UI.importFileInput.click());
        UI.importFileInput.addEventListener('change', handleImport);
        UI.exportBtn.addEventListener('click', handleExport);
        UI.resetDataBtn.addEventListener('click', () => UI.resetDataModal.style.display = 'flex');

        UI.sidebarToggle.addEventListener('click', e => { 
            e.stopPropagation(); 
            UI.app.classList.add('sidebar-is-open'); 
            UI.sidebar.classList.add('visible'); 
            UI.sidebarOverlay.classList.add('visible');
        });
        UI.sidebarOverlay.addEventListener('click', closeMobileSidebar);

        UI.mobileSearchBtn.addEventListener('click', () => {
            UI.mobileSearchBar.classList.add('visible');
            UI.mobileSearchInput.focus();
        });
        UI.closeSearchBtn.addEventListener('click', () => {
            UI.mobileSearchBar.classList.remove('visible');
            UI.mobileSearchInput.value = '';
            updateUI();
        });

        UI.promptBody.addEventListener('input', updateCharCounter);
        UI.tagsContainer.addEventListener('click', e => { if (e.target.classList.contains('remove-tag')) removeTag(e.target.dataset.tag); else UI.tagsInput.focus(); });
        
        UI.tagsInput.addEventListener('keydown', handleTagInputKeydown);
        UI.tagsInput.addEventListener('input', handleTagInput);
        UI.tagsInput.addEventListener('focus', () => renderTagSuggestions(UI.tagsInput.value));
        UI.tagsInput.addEventListener('blur', () => { setTimeout(() => UI.tagSuggestions.style.display = 'none', 150); });
        UI.tagSuggestions.addEventListener('mousedown', handleSuggestionClick);

        
        // Modal listeners
        UI.cancelMoveBtn.addEventListener('click', () => UI.moveModal.style.display = 'none');
        UI.confirmMoveBtn.addEventListener('click', handleConfirmMove);
        UI.moveModal.addEventListener('click', (e) => { if (e.target === UI.moveModal) UI.moveModal.style.display = 'none'; });

        UI.cancelDeleteFolderBtn.addEventListener('click', () => { UI.deleteFolderModal.style.display = 'none'; state.folderToDeleteId = null; });
        UI.confirmDeleteFolderMoveBtn.addEventListener('click', handleDeleteFolderMove);
        UI.confirmDeleteFolderAndPromptsBtn.addEventListener('click', handleDeleteFolderAndPrompts);
        UI.deleteFolderModal.addEventListener('click', (e) => { if (e.target === UI.deleteFolderModal) { UI.deleteFolderModal.style.display = 'none'; state.folderToDeleteId = null;} });

        UI.cancelResetBtn.addEventListener('click', () => UI.resetDataModal.style.display = 'none');
        UI.confirmResetBtn.addEventListener('click', handleResetAllData);
        UI.resetDataModal.addEventListener('click', (e) => { if(e.target === UI.resetDataModal) UI.resetDataModal.style.display = 'none' });
        
        UI.promptFolder.addEventListener('change', handleFolderDropdownChange);
    }
    
    async function handleFolderDropdownChange() {
        if (UI.promptFolder.value !== '--create-new--') return;
        const currentSelection = state.currentPromptId ? state.prompts.find(p => p.id === state.currentPromptId).folderId || 'all' : 'all';
        const folderName = await ModalService.prompt('Enter new folder name:', { title: 'Create Folder' });

        if (folderName && folderName.trim()) {
            const newFolder = { id: Date.now(), name: folderName.trim() };
            state.folders.push(newFolder);
            saveData();
            renderSidebarNav();
            renderFolderDropdown();
            UI.promptFolder.value = newFolder.id;
        } else {
            UI.promptFolder.value = currentSelection;
        }
    }

    async function handleSavePrompt() {
        const title = UI.promptTitle.value.trim(), body = UI.promptBody.value.trim();
        if (!title && !body) { 
            await ModalService.alert("Prompt must have a title or body.", "Cannot Save");
            return; 
        }
        const now = Date.now(), folderId = UI.promptFolder.value === 'all' || UI.promptFolder.value === '--create-new--' ? null : Number(UI.promptFolder.value);
        
        if (state.currentPromptId && !state.isCreatingNew) {
            const prompt = state.prompts.find(p => p.id === state.currentPromptId);
            Object.assign(prompt, { title, body, folderId, notes: UI.promptNotes.value.trim(), tags: state.currentTags, dateModified: now });
        } else {
            const newPrompt = { id: now, dateCreated: now, dateModified: now, title, body, folderId, isFavorite: false, notes: UI.promptNotes.value.trim(), tags: state.currentTags };
            state.prompts.push(newPrompt);
        }
        
        saveData();
        renderSidebarNav();
        renderPrompts();
        closePromptDetailsView();
    }
    
    function handleSidebarNavClick(e) {
        const deleteBtn = e.target.closest('.delete-folder-btn');
        if (deleteBtn) {
            e.stopPropagation();
            state.folderToDeleteId = Number(deleteBtn.dataset.folderId);
            const folder = state.folders.find(f => f.id === state.folderToDeleteId);
            if (!folder) return;
            const promptCount = state.prompts.filter(p => p.folderId === state.folderToDeleteId).length;
            
            UI.deleteFolderModal.querySelector('h3').textContent = `Delete "${folder.name}"`;
            UI.confirmDeleteFolderMoveBtn.style.display = promptCount > 0 ? 'flex' : 'none';
            UI.confirmDeleteFolderAndPromptsBtn.textContent = promptCount > 0 ? `Delete Folder & ${promptCount} Prompts` : `Delete Empty Folder`;
            UI.confirmDeleteFolderMoveBtn.textContent = `Delete Folder & Move ${promptCount} Prompts`
            UI.deleteFolderModal.querySelector('p').textContent = promptCount > 0 
                ? `This folder contains ${promptCount} prompt(s). What would you like to do?`
                : 'Are you sure you want to delete this empty folder?';

            UI.deleteFolderModal.style.display = 'flex';
            return;
        }

        const target = e.target.closest('[data-id]');
        if (!target) return;
        closePromptDetailsView();
        UI.search.value = '';
        const { type, id } = target.dataset;
        if (state.view.type === type && state.view.id.toString() === id) {
            state.view = { type: 'folder', id: 'all' };
        } else {
            state.view = { type, id: (type === 'folder' && id !== 'all' && id !== 'favorites') ? Number(id) : id };
        }
        updateUI();
    }
    
    function handleDeleteFolderMove() {
        if (state.folderToDeleteId === null) return;
        state.prompts.forEach(p => { if (p.folderId === state.folderToDeleteId) p.folderId = null; });
        state.folders = state.folders.filter(f => f.id !== state.folderToDeleteId);
        if(state.view.id === state.folderToDeleteId) state.view = { type: 'folder', id: 'all' };
        
        UI.deleteFolderModal.style.display = 'none';
        state.folderToDeleteId = null;
        saveData(); updateUI();
    }

    function handleDeleteFolderAndPrompts() {
        if (state.folderToDeleteId === null) return;
        state.prompts = state.prompts.filter(p => p.folderId !== state.folderToDeleteId);
        state.folders = state.folders.filter(f => f.id !== state.folderToDeleteId);

        if(state.view.id === state.folderToDeleteId) state.view = { type: 'folder', id: 'all' };
        if (state.currentPromptId && !state.prompts.find(p => p.id === state.currentPromptId)) {
            state.currentPromptId = null;
        }

        UI.deleteFolderModal.style.display = 'none';
        state.folderToDeleteId = null;
        saveData(); updateUI();
    }

    function handlePromptListClick(e) {
        const li = e.target.closest('li[data-id]');
        if (!li) return;
        
        const promptId = Number(li.dataset.id);
        const favoriteToggle = e.target.closest('.favorite-toggle');
        const tag = e.target.closest('.prompt-list-tag');

        if (favoriteToggle) {
            e.stopPropagation();
            const prompt = state.prompts.find(p => p.id === promptId);
            if (prompt) { prompt.isFavorite = !prompt.isFavorite; saveData(); renderPrompts(); renderSidebarNav(); }
            return;
        }
        if (tag) {
            e.stopPropagation();
            const newView = { type: 'tag', id: tag.dataset.tag };
            if (state.view.type === newView.type && state.view.id === newView.id) {
                state.view = { type: 'folder', id: 'all' };
            } else {
                state.view = newView;
            }
            state.currentPromptId = null; UI.search.value = '';
            updateUI();
            return;
        }
        
        if (state.isSelectMode) {
            li.classList.toggle('selected');
            if (state.selectedPromptIds.has(promptId)) {
                state.selectedPromptIds.delete(promptId);
            } else {
                state.selectedPromptIds.add(promptId);
            }
            updateBulkActionUI();
        } else {
            openPromptDetailsView(false, promptId);
        }
    }
    
    function handleAddFolder() {
        const folderName = UI.newFolderName.value.trim();
        if (folderName) {
            state.folders.push({ id: Date.now(), name: folderName });
            UI.newFolderName.value = ''; UI.newFolderContainer.classList.remove('visible');
            saveData(); renderSidebarNav();
        }
    }
    
    function handleAddGlobalTag() {
        const tagName = UI.newTagName.value.trim();
        if (tagName) {
            const allTags = new Set([...state.prompts.flatMap(p => p.tags || []), ...state.globalTags]);
            if (!allTags.has(tagName)) {
                state.globalTags.push(tagName);
                saveData();
                renderSidebarTags();
            }
            UI.newTagName.value = ''; UI.newTagContainer.classList.remove('visible');
        }
    }
    
    function handleSelectAll() {
        const visibleIds = getFilteredAndSortedPrompts().map(p => p.id);
        const allVisibleSelected = visibleIds.length > 0 && visibleIds.every(id => state.selectedPromptIds.has(id));
        
        if (allVisibleSelected) {
            visibleIds.forEach(id => state.selectedPromptIds.delete(id));
        } else {
            visibleIds.forEach(id => state.selectedPromptIds.add(id));
        }
        renderPrompts();
        updateBulkActionUI();
    }
    
    async function handleBulkDelete() {
        if (state.selectedPromptIds.size === 0) return;
        const confirmed = await ModalService.confirm(`Delete ${state.selectedPromptIds.size} selected prompts?`, {
            title: 'Confirm Deletion',
            confirmBtnText: 'Delete',
            danger: true
        });

        if (confirmed) {
            state.prompts = state.prompts.filter(p => !state.selectedPromptIds.has(p.id));
            if (state.selectedPromptIds.has(state.currentPromptId)) state.currentPromptId = null;
            state.selectedPromptIds.clear(); state.isSelectMode = false;
            saveData(); updateUI();
        }
    }

    async function handleDeletePrompt() {
        if (!state.currentPromptId) return;
        const confirmed = await ModalService.confirm('Are you sure you want to delete this prompt?', {
            title: 'Confirm Deletion',
            confirmBtnText: 'Delete',
            danger: true
        });

        if (confirmed) {
            const idToDelete = state.currentPromptId;
            closePromptDetailsView();
            setTimeout(() => {
                state.prompts = state.prompts.filter(p => p.id !== idToDelete);
                saveData();
                renderPrompts(); 
                renderSidebarNav();
            }, parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--animation-duration')) * 1000);
        }
    }

    function handleBulkMove() {
        if(state.selectedPromptIds.size === 0) return;
        UI.moveCount.textContent = state.selectedPromptIds.size;
        UI.moveFolderSelect.innerHTML = `<option value="all">No Folder</option>`;
        state.folders.forEach(folder => UI.moveFolderSelect.innerHTML += `<option value="${folder.id}">${folder.name}</option>`);
        UI.moveModal.style.display = 'flex';
    }
    
    function handleConfirmMove() {
        const newFolderId = UI.moveFolderSelect.value === 'all' ? null : Number(UI.moveFolderSelect.value);
        state.prompts.forEach(p => { if(state.selectedPromptIds.has(p.id)) p.folderId = newFolderId; });
        state.selectedPromptIds.clear(); state.isSelectMode = false;
        UI.moveModal.style.display = 'none';
        saveData(); updateUI();
    }
    
    function handleImport(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = async e => {
            try {
                const data = JSON.parse(e.target.result);
                if (data && Array.isArray(data.prompts) && Array.isArray(data.folders)) {
                    const confirmed = await ModalService.confirm(
                        'This will overwrite all current data. This action cannot be undone.', 
                        { title: 'Confirm Import', confirmBtnText: 'Overwrite', danger: true }
                    );
                    if (confirmed) {
                        state.prompts = data.prompts; state.folders = data.folders;
                        state.globalTags = data.globalTags || [];
                        state.currentPromptId = null; state.isCreatingNew = false; state.view = { type: 'folder', id: 'all' };
                        saveData(); init(); 
                        await ModalService.alert('Import successful!', 'Success');
                    }
                } else { 
                    await ModalService.alert('The selected file has an invalid format.', 'Import Error');
                }
            } catch (error) { 
                await ModalService.alert('An error occurred while reading or parsing the file.', 'Import Error');
            }
        };
        reader.readAsText(file);
        UI.importFileInput.value = '';
    }

    function handleExport() {
        if (state.prompts.length === 0 && state.folders.length === 0) {
            ModalService.alert("There's no data to export.", "Export Empty");
            return;
        }
        const dataToExport = { prompts: state.prompts, folders: state.folders, globalTags: state.globalTags };
        const dataStr = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `promptcat_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }
    
    function handleResetAllData() {
        localStorage.removeItem('prompts');
        localStorage.removeItem('folders');
        localStorage.removeItem('globalTags');
        location.reload();
    }
    
    function renderTagSuggestions(inputValue) {
        if (!inputValue) {
            UI.tagSuggestions.style.display = 'none';
            return;
        }
        const allTags = [...new Set([...state.prompts.flatMap(p => p.tags || []), ...state.globalTags])];
        const suggestions = allTags.filter(tag => 
            tag.toLowerCase().includes(inputValue.toLowerCase()) && !state.currentTags.includes(tag)
        );

        if (suggestions.length > 0) {
            UI.tagSuggestions.innerHTML = suggestions.map(tag => `<div class="suggestion-item" data-tag="${tag}">${tag}</div>`).join('');
            UI.tagSuggestions.style.display = 'block';
        } else {
            UI.tagSuggestions.style.display = 'none';
        }
    }

    function handleSuggestionClick(e) {
        const tag = e.target.dataset.tag;
        if (tag) {
            addTag(tag);
            UI.tagsInput.value = '';
            UI.tagSuggestions.style.display = 'none';
            UI.tagsInput.focus();
        }
    }
    
    function handleTagInput() {
        const value = UI.tagsInput.value;
        if (value.endsWith(',')) {
            const tagText = value.slice(0, -1);
            addTag(tagText);
            UI.tagsInput.value = '';
        }
        renderTagSuggestions(UI.tagsInput.value);
    }

    function handleTagInputKeydown(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addTag(UI.tagsInput.value);
            UI.tagsInput.value = '';
            UI.tagSuggestions.style.display = 'none';
        }
    }
    
    function handleCopyPrompt() {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(UI.promptBody.value).then(() => {
                if(state.copyTimeout) clearTimeout(state.copyTimeout);
                
                UI.copyPromptBtn.classList.add('copied');
                const originalTitle = UI.copyPromptBtn.title;
                UI.copyPromptBtn.title = 'Copied!';
                UI.copyPromptBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;

                state.copyTimeout = setTimeout(() => {
                    UI.copyPromptBtn.classList.remove('copied');
                    UI.copyPromptBtn.title = originalTitle;
                    UI.copyPromptBtn.innerHTML = `<svg class="copy-icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                ModalService.alert('Could not copy to clipboard.');
            });
        }
    }

    init();
});
</script>
</body>
</html>